# FROM quay.io/jupyter/pytorch-notebook:cuda11-python-3.11.9
FROM nvcr.io/nvidia/pytorch:24.05-py3

ARG CARLA_VER=0.9.15

# USER root

# Let us install tzdata painlessly
# ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
   neovim \
   python3-pip \
   python3-setuptools \
   libjpeg8 \
   libtiff5 \
   xdg-user-dirs \
   apt-utils \
   git \
   ubuntu-mono \
   fontconfig

# Copy requirements file
COPY jupyter-requirements.txt /tmp/

# Change permissions of pip cache directory (if necessary)
# RUN mkdir -p /home/jovyan/.cache/pip \
#  && chown -R root:root /home/jovyan/.cache/pip

# Install Python dependencies
RUN pip install --upgrade pip \
 && /usr/local/bin/pip install -r /tmp/jupyter-requirements.txt

# Scenario Runner
COPY scenario_runner-requirements.txt /tmp/

RUN pip3 install --upgrade pip \
 && /usr/local/bin/pip3 install -r /tmp/scenario_runner-requirements.txt

# RUN cd /opt \
#  && git clone -b leaderboard-2.0 --single-branch https://github.com/carla-simulator/scenario_runner.git

RUN cd /opt \
 && git clone -b v${CARLA_VER} --single-branch https://github.com/carla-simulator/scenario_runner.git

# Leaderboard

COPY leaderboard-requirements.txt /tmp/

RUN pip3 install --upgrade pip \
 && /usr/local/bin/pip3 install -r /tmp/leaderboard-requirements.txt

RUN cd /opt \
 && git clone -b leaderboard-2.0 --single-branch https://github.com/carla-simulator/leaderboard.git

# CARLA
# RUN cd /opt \
#  && git clone -b ${CARLA_VER} --single-branch https://github.com/carla-simulator/carla.git 
# 
# RUN python3 -m easy_install --no-find-links --no-deps ${CARLA_ROOT}/PythonAPI/carla/dist/carla-${CARLA_VER}-py3.7-linux-x86_64.egg

ENV SCENARIO_RUNNER_ROOT=/opt/scenario_runner
ENV LEADERBOARD_ROOT=/opt/leaderboard
ENV PYTHONPATH=${SCENARIO_RUNNER_ROOT}:${PYTHONPATH}
ENV PYTHONPATH=${LEADERBOARD_ROOT}:${PYTHONPATH}
ENV CARLA_ROOT=/opt/carla
ENV PYTHONPATH=${CARLA_ROOT}/PythonAPI/carla/dist/carla-${CARLA_VER}-py3.7-linux-x86_64.egg:${PYTHONPATH}
ENV PYTHONPATH=${CARLA_ROOT}/PythonAPI/carla:${PYTHONPATH}
